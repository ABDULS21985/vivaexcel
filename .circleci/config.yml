version: 2.1

orbs:
  docker: circleci/docker@2.4.0
  ssh: circleci/ssh@0.1.0

executors:
  docker-executor:
    docker:
      - image: cimg/base:stable

jobs:
  build-and-push:
    executor: docker-executor
    parameters:
      app_name:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
          docker_layer_caching: true
      - run:
          name: Build and push Docker image
          command: |
            echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
            IMAGE_NAME="${DOCKERHUB_USERNAME}/digibit-<< parameters.app_name >>:latest"
            docker build --build-arg APP_NAME=<< parameters.app_name >> -t ${IMAGE_NAME} .
            docker push ${IMAGE_NAME}

  deploy:
    executor: docker-executor
    steps:
      - checkout
      - run:
          name: Set up SSH and Deploy
          command: |
            mkdir -p ~/.ssh
            echo "${VPS_SSH_KEY}" > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            ssh-keyscan -H "${VPS_HOST}" >> ~/.ssh/known_hosts
            
            # Ensure target directory exists
            ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no "${VPS_USER}@${VPS_HOST}" "mkdir -p ~/digiweb"
            
            # Transfer docker-compose.yml
            scp -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no docker-compose.yml "${VPS_USER}@${VPS_HOST}:~/digiweb/docker-compose.yml"
            
            # Run deployment commands
            ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no "${VPS_USER}@${VPS_HOST}" bash << EOF
              set -e
              cd ~/digiweb
              
              # Export Dockerhub username for docker-compose
              export DOCKERHUB_USERNAME="${DOCKERHUB_USERNAME}"
              
              # Login to Docker Hub
              echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
              
              # Pull latest images
              docker compose pull
              
              # Restart services
              docker compose up -d --remove-orphans
              
              # Clean up old images
              docker image prune -f
              
              echo "Deployment completed successfully!"
            EOF

workflows:
  version: 2
  build-deploy:
    jobs:
      - build-and-push:
          name: build-frontend
          app_name: frontend
          filters:
            branches:
              only: master
      - build-and-push:
          name: build-dashboard
          app_name: dashboard
          filters:
            branches:
              only: master
      - build-and-push:
          name: build-backend
          app_name: backend
          filters:
            branches:
              only: master
      - deploy:
          requires:
            - build-frontend
            - build-dashboard
            - build-backend
          filters:
            branches:
              only: master
